<?xml version="1.0" encoding="UTF-8"?>
<mapping-configuration>
	<sql namespace="DataRel">
		
		<!-- 删除Value集合 -->
		<content name="deleteValues" type="delete">
			<switch>
				<if test="flag == 1">
					delete base_data_rel where left_type=#{parentType} and left_value=#{parentValue} and right_type=#{childType} and tenant_id=#{tenantId} 
				</if>
				<else>
					delete base_data_rel where right_type=#{parentType} and right_value=#{parentValue} and left_type=#{childType} and tenant_id=#{tenantId} 
				</else>
			</switch>
		
			<switch>
				<if test="projectCode == null">
					and project_code is null
				</if>
				<else>
					and project_code=#{projectCode}
				</else>
			</switch>
		</content>
		
		<!-- 查询Value集合 -->
		<content name="queryValues" type="select">
			<switch>
				<if test="flag == 1">
					select right_value from base_data_rel where left_type=#{parentType} and left_value=#{parentValue} and right_type=#{childType} and project_code is null and tenant_id=#{tenantId} 
					<if test="projectCode != null">
						union
						select right_value from base_data_rel where left_type=#{parentType} and left_value=#{parentValue} and right_type=#{childType} and project_code=#{projectCode} and tenant_id=#{tenantId} 
					</if>
				</if>
				<else>
					select left_value from base_data_rel where right_type=#{parentType} and right_value=#{parentValue} and left_type=#{childType} and project_code is null and tenant_id=#{tenantId} 
					<if test="projectCode != null">
						union
						select left_value from base_data_rel where right_type=#{parentType} and right_value=#{parentValue} and left_type=#{childType} and project_code=#{projectCode} and tenant_id=#{tenantId} 
					</if>
				</else>
			</switch>
		</content>
		
		<!-- 查询指定的userId和projectCodes是否存在关联数据 -->
		<content name="query4UserIdAndProjectCodes" type="select">
			select count(id) from base_data_rel where left_type='USER_ID' and left_value=#{userId} and right_type='PROJECT_CODE' and 
			<switch>
				<if test="parentProjectCodes == null">
					right_value= #{projectCode}
				</if>
				<else>
					right_value in (#{projectCode},
					<foreach collection="parentProjectCodes" alias="parentProjectCode" separator="," close=") ">
						#{parentProjectCode}
					</foreach> 
				</else>
			</switch>
			and tenant_id=#{tenantId}
		</content>
		
	</sql>
</mapping-configuration>